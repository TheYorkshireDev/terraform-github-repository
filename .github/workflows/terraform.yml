name: Terraform

on:
  pull_request:

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Install terraform-docs
        working-directory: /tmp
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          mkdir /home/runner/bin
          mv terraform-docs /home/runner/bin
          ls /home/runner/bin
          echo "/home/runner/bin" >> $GITHUB_PATH

      - name: Test terraform-docs
        run: |
          terraform-docs --version
          which terraform-docs


# mkdir /home/runner/bin
# cd /home/runner/bin
# curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
# tar -xzf terraform-docs.tar.gz
# chmod +x terraform-docs
# echo "/home/runner/bin" >> $GITHUB_PATH
# cd $GITHUB_WORKSPACE
# which terraform-docs
# terraform-docs --version

      - name: Does This Run Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const execSync = require('child_process').execSync;
            const output = execSync('terraform-docs markdown table --indent 2 .', { encoding: 'utf-8' });  // the default is 'buffer'

            var commentBody = `### ‚ö†Ô∏è Terraform Documentation Outdated`

            var commentBody += `
            #### Update \`./README.md\` üìñ
            <details><summary>Show Markdown</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>

            #### Update \`./examples/basic-github-repository/README.md\` üìñ
            <details><summary>Show Markdown</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>

            #### Update \`./test/fixtures/basic-repository/README.md\` üìñ
            <details><summary>Show Markdown</summary>

            \`\`\`
            ${output}
            \`\`\`
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            })

      # - name: Render terraform docs inside the README.md and push changes back to PR branch
      #   uses: terraform-docs/gh-actions@v1.0.0
      #   with:
      #     find-dir: . # INPUT_FIND_DIR
      #     output-file: README.md #INPUT_OUTPUT_FILE
      #     output-method: print # INPUT_OUTPUT_METHOD
      #     git-push: 'false' # INPUT_GIT_PUSH
