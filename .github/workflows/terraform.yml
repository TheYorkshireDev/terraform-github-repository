name: Terraform

on:
  pull_request:

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Install terraform-docs
        working-directory: /tmp
        run: |
          curl -sSLo ./terraform-docs.tar.gz https://terraform-docs.io/dl/v0.16.0/terraform-docs-v0.16.0-$(uname)-amd64.tar.gz
          tar -xzf terraform-docs.tar.gz
          chmod +x terraform-docs
          mkdir /home/runner/bin
          mv terraform-docs /home/runner/bin
          ls /home/runner/bin
          echo "/home/runner/bin" >> $GITHUB_PATH

      - name: terraform-docs Commenter
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const script = require('./.github/scripts/commenter.js')
            console.log(script({github, context}))


      # - name: Does This Run Comment
      #   uses: actions/github-script@v6
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const path = require('node:path');
      #       const globa = require('glob');
      #       const execSync = require('child_process').execSync;

      #       function findTerraformDirectories() {
      #         var directories = []

      #         let files = []
      #         files = globa.sync("**/*.tf", {})
      #         files.forEach(file => {
      #           var directory = path.dirname(file)
      #           if (directories.indexOf(directory) === -1)
      #             directories.push(directory)
      #         });

      #         return directories.sort()
      #       }

      #       function isDocumentationOutdated(directory) {
      #         try {
      #           execSync('terraform-docs markdown table --indent 2 --output-check --output-file README.md .', { encoding: 'utf-8' });
      #         }
      #         catch (err) {
      #           return true
      #         }

      #         return false
      #       }

      #       function getTerraformDocumentation(directory) {
      #         return execSync('terraform-docs markdown table --indent 2 .', { encoding: 'utf-8' });  // the default is 'buffer'
      #       }

      #       function buildCommentOutput(directory, documentationOutput) {
      #         return `#### Update \`${directory}/README.md\` üìñ
      #       <details><summary>Show Markdown</summary>

      #       \`\`\`
      #       ${documentationOutput}
      #       \`\`\`
      #       </details>
      #       `;
      #       }

      #       // Run:
      #       var directories = findTerraformDirectories();
      #       console.log(directories)

      #       var commentBody = ``

      #       var tempDir = "."
      #       if (isDocumentationOutdated(tempDir))
      #       {
      #         if (commentBody === "")
      #         {
      #           commentBody += `### ‚ö†Ô∏è Terraform Documentation Outdated
      #       `
      #         }

      #         readmeDocumentation = getTerraformDocumentation(tempDir)
      #         commentBody += buildCommentOutput(tempDir, readmeDocumentation);
      #       }

            # github.rest.issues.createComment({
            #   issue_number: context.issue.number,
            #   owner: context.repo.owner,
            #   repo: context.repo.repo,
            #   body: commentBody
            # })

      # - name: Render terraform docs inside the README.md and push changes back to PR branch
      #   uses: terraform-docs/gh-actions@v1.0.0
      #   with:
      #     find-dir: . # INPUT_FIND_DIR
      #     output-file: README.md #INPUT_OUTPUT_FILE
      #     output-method: print # INPUT_OUTPUT_METHOD
      #     git-push: 'false' # INPUT_GIT_PUSH
